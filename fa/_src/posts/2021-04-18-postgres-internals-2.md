    Title: پستگرس چگونه کار می‌کند؟ جلسه دو - جدول‌های سیستمی
    Date: 2021-04-18T00:00:00
    Tags: پستگرس

در [جلسه یک](/fa/2021/04/پستگرس-چگونه-کار-می-کند-جلسه-یک-زندگی-یک-کوئری.html) گفتیم که پستگرس پس از parse کردن کوئری، در مرحله آنالیز
ارجاعات به جداول، ستون‌ها، ... را بررسی می‌کند.

مثلا در کوئری زیر:

```
SELECT a, b FROM t WHERE a > 0;
```

باید ارجاعات زیر بررسی شوند:

۱. آیا جدولی به نام t وجود دارد؟ در صورت وجود، فراداده‌ی مربوط به t (مثل مسیر فایل داده) چیست؟
۲. آیا جدول t ستون‌هایی به نام a و b دارد؟ در صورت وجود، این ستون‌ها چندمین ستون‌ها در این جدول هستند؟
۳. نوع داده‌های ستون‌های a و b چیست؟
۴. فرض کنید نوع ستون a عدد صحیح است. آیا عمل `a > 0` برای اعداد صحیح تعیین شده است؟ اگر بلی، برای انجام این عمل باید از چه تابعی باید استفاده شود؟

در این بخش به این می‌پردازیم که پستگرس چگونه به سوال‌های بالا پاسخ می‌دهد.

<!-- more -->

### پیش‌نیازها

برای دنبال کردن این بخش نیازی ندارید [جلسه یک](/fa/2021/04/پستگرس-چگونه-کار-می-کند-جلسه-یک-زندگی-یک-کوئری.html) را خوانده باشید.

ولی نیاز دارید که پستگرس را کامپایل و نصب کرده باشید. گام‌های لازم برای این امر را در 
[این مقاله](/fa/2020/05/پستگرس-چگونه-کار-می-کند-جلسه-صفر.html) آورده‌ام.

## فراداده‌ی جدول: pg_class

فراداده‌ی مربوط به جدول‌ها در جدول سیستمی pg_class قرار دارد. مثلا برای اینکه فراداده جدول به نام t را ببینیم، می‌توانیم از کوئری زیر استفاده کنیم. بخش‌هایی از خروجی را در زیر می‌بینید:

```
postgres=# SELECT * FROM pg_class WHERE relname='t';
-[ RECORD 1 ]-------+------
oid                 | 16394
relname             | t
...
relfilenode         | 16394
...
relkind             | r
relnatts            | 2
...
```

در خروجی بالا:

* مقدار relname نام جدول است.
* مقدار oid شماره داخلی جدول است. در آینده خواهیم دید که این شماره در جدول‌های سیستمی دیگر (مثلا جدول مربوط به ستون‌ها) برای اشاره به جدول استفاده می‌شود.
* مقدار relkind نشان می‌دهد که این رکورد در pg_class در واقع مربوط به یک جدول است. جدول سیستمی pg_class می‌تواند شامل فراداده ایندکس، view، ... نیز باشد که برای آن موارد مقدار relkind متفاوت خواهد بود.
* مقدار relnatts تعداد ستون‌های جدول را نشان می‌دهد.

#### relfilenode

در خروجی بالا مقدار relfilenode نام فایلی است که در دیسک برای ذخیره اطلاعات جدول t استفاده شده است. مسیر کامل فایل از فرمول زیر به دست می‌آید:

```
$PGDATA/base/$database_id/$relfilenode
```

که $PGDATA مسیر دایرکتوری کلاستر پستگرس است. اسم این دایرکتوری را موقع اجرای initdb انتخاب کردید. اگر مسیر این دایرکتوری را فراموش کرده‌اید، از دستور زیر می‌توانید استفاده کنید:

```
postgres=# show data_directory;
-[ RECORD 1 ]--+----------------
data_directory | /home/hadi/data
```

$database_id شماره داخلی دیتابیس است. اسم دیتابیسی که ما استفاده می‌کنیم postgres است. برای یافتن شماره آن می‌توانید از جدول pg_class استفاده کنید:

```
postgres=# select oid from pg_database where datname='postgres';
  oid
-------
 12675
(1 row)
```

پس برای جدول بالا مسیر فایل مربوط به جدول t، خواهد بود: `/home/hadi/data/base/12675/16394`.

برای آسانی، می‌توانید از دستور زیر نیز برای یافتن مسیر فایل استفاده کنید:

```
postgres=# SELECT pg_relation_filepath('t');
 pg_relation_filepath
----------------------
 base/12675/16394
(1 row)
```

#### آیا relfilenode همیشه با شماره جدول یکسان است؟

در خروجی بالا دیدیم که هم شماره جدول (oid) و هم relfilenode یکسان و برابر با 16394 بودند. مقدار اولیه این دو یکسان است. مقدار شماره جدول هیچ‌گاه تغییر نمی‌کند، ولی برخی دستورات
هستند که ممکن است relfilenode را تغییر دهند. مثلا دستور TRUNCATE که تمام سطرهای یک جدول را حذف می‌کند:

```
postgres=# truncate t;
TRUNCATE TABLE
postgres=# select oid, relfilenode from pg_class where relname='t';
  oid  | relfilenode
-------+-------------
 16394 |       24586
(1 row)
```

پیاده‌سازی داخلی TRUNCATE ابتدا یک فایل خالی با نام relfilenode جدید ایجاد می‌کند، سپس مقدار relfilenode را در pg_class تغییر می‌دهد، و سپس فایل قدیمی را پاک می‌کند.

#### منابع بیشتر

* [اطلاعات کامل درباره pg_class](https://www.postgresql.org/docs/current/catalog-pg-class.html)
* [کد تغییر relfilenode](https://github.com/postgres/postgres/blob/091e22b2e673e3e8480abd68fbb827c5d6979615/src/backend/utils/cache/relcache.c#L3576)

## فراداده ستون‌ها: pg_attribute

## فراداده نوع‌ها: pg_type

## فراداده عملگرها: pg_operator

## فراداده تابع‌ها: pg_proc


