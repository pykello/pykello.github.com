<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>cstore_fdw and 'Files are Hard'</title>
    <meta name="description" content="I recently came accross the &quot;Files are hard&quot; article, and it made me wonder how reliable is cstore_fdw's design and implementation. cstore_fdw is a columnar store for PostgreSQL that I designed and developed in my previous job at Citus Data.  I am writing...">
    <meta name="author"      content="Hadi Moshayedi">
    <meta name="keywords"    content="postgres">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.svg">
    <link rel="canonical" href="https://pykello.github.com/2015/12/cstore-fdw-and-files-are-hard.html">
    <link rel="next" href="/2015/12/haskell-skyline.html">
    <link rel="prev" href="/2019/03/postgresql-internals-truncate.html">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/monochrome.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-xxxxx', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>

    <!-- Header -->

    <header id="header" class="parent justify-spaceBetween">
      <div class="inner w100 relative">
        <span class="f-left">
          <a href="/fa">
            <h1>
              <span>the</span>lost<span>packet</span>
            </h1>
          </a>
        </span>
      </div>
    </header>

    <div id="container">
        <main>
            <article>
  <header>
    <h1>cstore_fdw and &lsquo;Files are Hard&rsquo;</h1>
    <p class='date-and-tags'>
<time datetime="2015-12-15" pubdate="true">2015-12-15</time> :: <span class="tags"><a href="/tags/postgres.html">postgres</a></span></p>
    <p class='authors'><span class="authors">Hadi Moshayedi</span></p>
  </header>

<p>I recently came accross the "<a href="http://danluu.com/file-consistency/">Files are hard</a>" article, and it made me wonder how reliable is cstore_fdw&rsquo;s design and implementation. <a href="https://github.com/citusdata/cstore_fdw/">cstore_fdw</a> is a columnar store for PostgreSQL that I designed and developed in my previous job at Citus Data.</p>

<p>I am writing this post so my decisions for cstore_fdw&rsquo;s design get reviewed by more people, and I get some feedback and improve the design.</p>
<!-- more-->

<h2 id="file-structure">File Structure</h2>

<p>Structure of cstore_fdw is similar to <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+ORC">Hive&rsquo;s ORC</a>, but with some differences. One of the biggest differences is that cstore_fdw stores metadata in a separate file, while ORC stores it at the end of data file. The reason for this difference? It made avoiding data corruption much easier, as we will see later.</p>

<p>Each cstore_fdw table consists of two files:</p>

<ul>
 <li>Data file</li>
 <li>Metadata file</li></ul>

<h3 id="data-file">Data File</h3>

<p>cstore_fdw divides rows into stripes. Each stripe is 150K rows by default. For each stripe data is stored in column oriented manner.</p>

<p> <img src="/img/cstore-layout.svg" alt="cstore-layout" /></p>

<h3 id="metadata-file">Metadata File</h3>

<p>Metadata file is a small file which contains some version infomration, plus outline of the data file. This includes location and size of each stripe.</p>

<h2 id="operations">Operations</h2>

<p>Currently the only modification operation that cstore_fdw supports is batch insertion, which can be triggered using:</p>

<div class="brush: sql">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre><span class="normal">1</span></pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="k">COPY</span> <span class="n">cstore_table</span> <span class="k">FROM</span> <span class="s1">&#39;/path/to/file.csv&#39;</span> <span class="k">WITH</span> <span class="n">CSV</span><span class="p">;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>or:</p>

<div class="brush: sql">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre><span class="normal">1</span></pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">cstore_table</span> <span class="k">FROM</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">some_other_table</span> <span class="k">WHERE</span> <span class="n">some_condition</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Our plans were to first get batch inserts right, as this on its own was very useful to our customers who used it to store archive data. Then add support for single row inserts, deletes, and updates.</p>

<p>What does happen when we do a batch load?</p>

<ul>
 <li>For every 150K rows construct a new stripe and append it to the data file.  While doing this, never touch the metadata file.</li>
 <li>Sync and close the data file.</li>
 <li>Create a temporary metadata file, and write the metadata which represents the  newly inserted data to it.</li>
 <li>Sync and close the temporary metadata file.</li>
 <li>Rename the temporary metadata file to the main metadata file.</li></ul>

<p>If the system crashes during the first four steps, the table is still in a consistent state and we won&rsquo;t have data corruption.</p>

<p>This is because:</p>

<ul>
 <li>We don&rsquo;t change the main metadata file in these steps.</li>
 <li>We don&rsquo;t overwrite or move the old data in the data file.</li></ul>

<p>What about 5th step? The nice thing here is that the <a href="http://pubs.opengroup.org/onlinepubs/009695399/functions/rename.html">specification</a> of the rename system call requires it to be automic. So this step either is done in full (in which case we&rsquo;ll see the new data) or isn&rsquo;t done at all (in which case we&rsquo;ll see the old data, but we won&rsquo;t have data corruption).</p>

<p>And that is the reason for using a separate file for metadata. I needed an atomic operation to rely on, and rename is atomic. Rewriting the whole data in a new file and doing the rename for data file wasn&rsquo;t an option, since it is very expensive. So instead, we rewrite the small metadata file and do the rename for that.</p>

<p>Of course there were some other designs which avoided file corruption, but I found this design very simple compared to other designs.</p>

<p>Reading the <a href="https://news.ycombinator.com/item?id=10729132">discussion in hacker news</a> for &ldquo;Files are hard&rdquo;, I see that I&rsquo;ve missed a step, which is doing a sync on the parent directory to make the rename durable. That is something we should fix, but I&rsquo;m happy that our design seem to avoid most of the issues discussed in &ldquo;Files are hard&rdquo;.</p>

<h2 id="links">Links</h2>

<ul>
 <li><a href="https://news.ycombinator.com/item?id=10741385">Hacker News Discussion</a></li></ul>
  <footer>
    <script type="text/javascript">
      !function(d,s,id){
          var js,fjs=d.getElementsByTagName(s)[0];
          if(!d.getElementById(id)){
              js=d.createElement(s);
              js.id=id;
              js.src="//platform.twitter.com/widgets.js";
              fjs.parentNode.insertBefore(js,fjs);
          }
      }(document,"script","twitter-wjs");
    </script>
    <a href="https://twitter.com/share"
       class="twitter-share-button"
       data-url="https://pykello.github.com/2015/12/cstore-fdw-and-files-are-hard.html"
       data-dnt="true">
      "Tweet"</a>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.identifier = undefined;
        this.page.url = undefined;
        this.page.title = undefined;
        this.page.category_id = undefined;
      };
      var disqus_shortname = 'pykello';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          dsq.setAttribute('data-timestamp', +new Date());
          (document.head || document.body).appendChild(dsq);
      })();
    </script>
    <noscript>
      Please enable JavaScript to view the
      <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </footer>
</article>
        </main>
        <footer>
            <hr />
            <p><a href="https://twitter.com/pykello"
                  class="twitter-follow-button"
                  data-show-count="false"
                  data-lang="en">
                 "Follow Hadi Moshayedi"
               </a>
               <script type="text/javascript">
                 !function(d,s,id){
                     var js,fjs=d.getElementsByTagName(s)[0];
                     if(!d.getElementById(id)){
                         js=d.createElement(s);
                         js.id=id;
                         js.src="//platform.twitter.com/widgets.js";
                         fjs.parentNode.insertBefore(js,fjs);
                     }
                 }(document,"script","twitter-wjs");
               </script></p>
          </footer>
    </div>
  </body>
</html>